---
title: "ST 558 Project 1"
author: "Rebecca Voelker"
date: "10/05/2021"
---

This document will walk the reader through the process of connecting to & collecting data from the COVID API within R.  

##### __Render Code (for Reference ONLY)__

```{r, Render, eval=FALSE}
rmarkdown::render("ST_558_Project_1.Rmd", "github_document","README.md")
```

#### __Packages Required for Vignette__

The below packages are required for connecting to the API, as well as the subsequent data analysis and exploration performed on the data retrieved from the API.  

1. `httr` - _Retrieves Data from API_
2. `jsonlite` - _Parses Results from API Query_
3. `dplyr` - _A part of the `tidyverse` universe of packages, specifically used for manipulating data_
4. `tidyr` - 
4. `ggplot2` - _A part of the `tidyverse` universe of packages, specifically for creating graphs_

```{r libraries, message=FALSE}

library(httr)
library(jsonlite)
library(dplyr)
library(tidyr)
library(ggplot2)
```

#### __COVID API Function Calls__

Below are 6 functions I have created to call various endpoints of the [COVID-19 API Data](https://documenter.getpostman.com/view/10808728/SzS8rjbc#e831c268-9da1-4d86-8b5a-8d7f61910af8).

Note that for each function created, I have performed a test of the functional call, outputting the object as *functionname*_Test. 

##### `CountryFun`

This function call, calls in a user-specified country and it's  slug-code

```{r function1}

CountryFun <- function(country){
  base <- "https://api.covid19api.com/live/country/"
  endpoint <- country
  paste <- paste(base, endpoint, sep = "")
  outputAPI <- fromJSON(paste)
  return(as_tibble(outputAPI))
}

CountryFun_Test <- CountryFun("australia")
```

##### `CountryCOVIDFun`

This function call, calls in the details of COVID cases in a user-specified country. Details include the Total Number of Confirmed COVID Cases, the Total Number of Recoveries, and the Total Number of Deaths. 

```{r function2}
CountryCOVIDFun <- function(country){
  API_init <- GET("https://api.covid19api.com/summary")
  API_content <- content(API_init, as = "text")
  API_JSON <- fromJSON(API_content)
  output <- API_JSON$Countries %>% select(ID:TotalRecovered) %>% filter(Country == country)
}

CountryCOVIDFun_Test <- CountryCOVIDFun("South Africa") 
```

##### `CountryConfirmFun`

This function call, calls in the details of COVID cases in a user-specified country, *by province/state*. Details include the Total Number of Confirmed COVID Cases, the Total Number of Recoveries, and the Total Number of Deaths.
 User can also specify if they would like to look at the data, as-of a specific # of Confirmed Cases.
 
```{r function3}
CountryConfirmFun <- function(x, y){
  base <- "https://api.covid19api.com/live/country/"
  endpoint <- x
  paste_url <- paste(base, endpoint, sep = "")
  API_init <- GET(paste_url)
  API_content <- content(API_init, as = "text")
  API_JSON <- fromJSON(API_content)
  output <- API_JSON %>% filter(Confirmed >= y)
  return(output)
}

CountryConfirmFun_Test <- CountryConfirmFun("australia", 5000)

```

##### `USCOVIDFun`

This function call, calls the details of COVID cases in a particular state in the United States. Details include the Total Number of Confirmed COVID Cases, the Total Number of Recoveries, and the Total Number of Deaths.

```{r function4}

USCOVIDFun <- function(province){
  API_init <- GET("https://api.covid19api.com/live/country/USA")
  API_content <- content(API_init, as = "text")
  API_JSON <- fromJSON(API_content)
  output <- API_JSON %>% filter(Province == province)
  return(output)
}

USCOVIDFun_Test <- USCOVIDFun("Wisconsin")
```

##### `USConfirmFun`

This function call, calls the details of the first instance, per state, of COVID cases greater than (or equal to) a user-specified # of cases. Details include the State Name, Latitude & Longitude of the State, Total Number of Recovers, and the Total Number of Deaths and the date the # of Confirmed Cases first hit >= the User-Specified value.

```{r function5}
USConfirmFun <- function(x){
  API_init <- GET("https://api.covid19api.com/live/country/USA")
  API_content <- content(API_init, as = "text")
  API_JSON <- fromJSON(API_content)
  output <- API_JSON %>% filter(Confirmed >= x) %>% arrange(Province, Confirmed)
  output_subset <- output[match(unique(output$Province), output$Province),]
  return(output_subset)
}

USConfirmFun_Test <- USConfirmFun(100000)
```

##### `USDeathFun`

This function call, calls the details, per state, of each day COVID deaths greater than (or equal to) a user-specified # of deaths. Details include the State Name, Latitude & Longitude of the State, Total Number of Recovers, and the Total Number of Deaths and each day the # of deaths hit >= the User-Specified value.

```{r function6}
USDeathFun <-function(x){
  API_init <- GET("https://api.covid19api.com/live/country/USA")
  API_content <- content(API_init, as = "text")
  API_JSON <- fromJSON(API_content)
  output <- API_JSON %>% filter(Deaths >= x) %>% arrange(Province, Deaths)
  return(output)
}

USDeathFun_Test <- USDeathFun(5000)
```

#### __Exploratory Data Analysis__

Now that we have created multiple function calls, to call different elements / data sets, it is time to perform some exploratory data analysis.

Firstly, I want to look at the Rate of Active Cases in North Carolina over time to see how (or if) it is changing. Using the `USCOVIDFun` Function Call, this is going to require me to create a new variable: 

1. Rate of Active Cases out of the Total Number of Confirmed Cases

```{r new_var1, warning=FALSE}

# Create an Output Object of COVID Cases in NC.
NCCovidCases <- USCOVIDFun("North Carolina")

# Create First New Variable that Reports the Rate of Active Cases
NCCovidCases <- mutate(NCCovidCases, ActiveRate = Active/Confirmed)

# Convert Date Variable to a Date Format
NCCovidCases <- mutate(NCCovidCases, Date_Num = as.Date(strtrim(NCCovidCases$Date, 10)))

```

Now that we have created the necessary variable, and converted 'Date', we can plot these two variables against each other to see the Rate of Active Cases over time.

Looking at the visual below, we can see that (although small) there has been an increase in the rate of Active Cases in the past few months.

```{r graph1}

g1 <- ggplot(NCCovidCases, aes(x=Date_Num, y=ActiveRate)) +
  geom_line() + xlab("Date (2021)") +ylab("Rate of Active Cases")

g1

```

Now, using this same data set, I want to look at the # of deaths per month. This will require me to create a new variable, 'Month' in order to group the observations. I am also going to filter this data so that I am only looking at the past 3 *full* months of data.

```{r new_var2, warning=FALSE}

# Create a 'Helper' Column to Uniquely Identify Months
NCCovidCases <- NCCovidCases %>% separate(Date_Num, c(NA, "Month_Num"), remove=FALSE)

# Create Second New Variable that Groups by Month
NCCovidCases <- NCCovidCases %>% mutate(Month = if_else(Month_Num == "06", "June",
  if_else(Month_Num == "07", "July",
    if_else(Month_Num == "08", "August",
      if_else(Month_Num == "09", "September", "October")))))

#Create a Subset that Looks Only at Full Months of Data (excl. June & Oct.)
target <- c("July", "August", "September")
NCCovidCases <- NCCovidCases %>% filter(Month %in% target)

#Reorder Months to Appear in Sequential Order Box Plot
NCCovidCases$Month <- factor(NCCovidCases$Month, levels=c("July", "August", "September"))

```

Now that we have created the Month variable, we can create box-plots, by month, showing summary statistics for the # of deaths that month.

_Reminder: Deaths is cumulative, over time. Please keep this caveat in mind when reviewing this graph._

Looking at the visual below, we can draw a few conclusions. 
Firstly, the number of deaths goes up each month, which is consistent with the understanding of the caveat above (i.e. this is cumulative data). 

Secondly, we can see that the September had the most deaths because it had the largest difference it's maximum value and it's minimum value.

```{r graph2}

g2 <- ggplot(NCCovidCases, aes(x=Month, y=Deaths))+
  geom_boxplot()+labs(x = "Month", y = "Cumulative Deaths")

g2
```

It might help to look at a numerical summary associated with these values to better understand.

Looking at this data, we can see take the Minimum # of Deaths for each Month and subtract it from the Maximum # of Deaths for that same Month. This will give us the # of Deaths for that Month. Consistent with our Box Plots, we can see that September had over 2 times the number of deaths as compared August and nearly 10 times the number of deaths as compared to July.

```{r numerical summary, warning=FALSE}

#Generate a Numerical Summary that Shows the # of Deaths per Month in NC. 

NCCovidCases %>% group_by(Month) %>% summarise(MonthlyDeaths = max(Deaths)-min(Deaths)) 

```

Let's move outside of the United State now and look at some COVID data from abroad, specifically Australia. We will use the `CountryConfirmFun` Function Call to pull in data about COVID Cases in Australia.

Here I am looking at the Number of Active Cases as Compared to the # of Deaths, by Province. We can see that these two variables look to be positively correlated based on the patterns in the scatter plots. As the number of Active Cases goes up, so does the number of Deaths. 

```{r graph3}

AUSConfirms <- CountryConfirmFun("australia", 0)

g5 <- ggplot(AUSConfirms, aes(x=Active, y=Deaths))+
  geom_point() + facet_wrap(~ Province)

g5
```

Let's drill down into the Provinces where we have seen the most Confirmed Cases - New South Wales and Victoria. The below histograms show us that # of days that a Death Count was a certain value in New South Wales and Victoria, respectively.

```{r graph4}

#Create a Subset that Looks Only at New South Wales and Victoria
target <- c("New South Wales", "Victoria")
AUSConfirms <- AUSConfirms %>% filter(Province %in% target)

g4 <- ggplot(AUSConfirms, aes(x=Deaths)) +
  geom_histogram()+facet_grid(~Province)

g4

```
Looking at these two histograms, we can see a pretty distinct grouping of the Death Counts, by Province.It might help to look at a Contingency Table associated with these values to better understand.

I created a variable that buckets the # of Deaths into __Low__ (< 250), __Medium__ (>= 250 and < 500), and __High__ (>=500). Remember that the Death Variable is cumulative. Therefore we can read the Contingency Table below, as follows: 

There were 83 consecutive days (beginning June 25th, 2021) where the Death Count remained below 250 people in New South Wales. After 83 days, the Death Count topped 250 people for 16 days (Up To Present-Day). The Death Count in Victoria has been greater than 500 people (Likely ~800 people, looking at the above histogram) since at least June 25th, 2021.  

```{r contingency table}

# Create Third New Variable that Groups Death Count
AUSConfirms <- AUSConfirms %>% mutate(DeathBucket = if_else(Deaths >= 500, "High",
  if_else(Deaths >= 250, "Medium", "Low")))

#Reorder Buckets to Appear in Sequential Order in Contingency Table
AUSConfirms$DeathBucket <- factor(AUSConfirms$DeathBucket, levels=c("Low", "Medium", "High"))

table(AUSConfirms$Province, AUSConfirms$DeathBucket)

```


